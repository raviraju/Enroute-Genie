<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <style>
       #right-panel {
          font-family: 'Roboto','sans-serif';
          line-height: 30px;
          padding-left: 10px;
          overflow-y: auto;
          height: 100px;
        }

        #right-panel select, #right-panel input {
          font-size: 15px;
        }

        #right-panel select {
          width: 100%;
        }

        #right-panel i {
          font-size: 12px;
        }
        html, body {
          height: 100%;
          margin: 0;
          padding: 0;
        }
        #map {
          height: 100%;
          float: left;
          width: 75%;
          height: 100%;
        }
        #right-panel {
          float: right;
          width: 22%;
          height: 100%;
        }
        .panel {
          height: 100%;
          overflow: auto;
        }
        #floating-panel {
            position: relative;
            top: 10px;
            left: 5px;
            z-index: 1;
            background-color: #fff;
            padding: 5px;
            border: 1px solid #999;
            text-align: center;
            font-family: 'Roboto','sans-serif';
            line-height: 30px;
            padding-left: 10px;
          }
    </style>
    <title>Enroute Genie</title>
    <script src="https://cdn.jsdelivr.net/pouchdb/6.0.7/pouchdb.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script>
        var pouchDB = new PouchDB('https://enroutegenie:genieenroute@enroutegenie.cloudant.com/enroute_genie');
        var srcDestDict = {};
        var map;
        var markers = [];
        function srcChanged(src){
            //console.log("Changed : ", src);
            var destinations = srcDestDict[src];
            for(var dest of destinations){
                var end = document.getElementById("end");
                var option = document.createElement("option");
                option.text = dest;
                end.add(option);
            }
        }
        pouchDB.allDocs().then(function (info) {
            for(var result of info.rows){
                srcDest = (result.id).split('_and_');
                //console.log(srcDest[0], srcDest[1]);
                if(srcDest[0] in srcDestDict){
                    srcDestDict[srcDest[0]].push(srcDest[1]);
                }else{
                    srcDestDict[srcDest[0]] = [srcDest[1]];
                }
            }
            //console.log("srcDestDict : ", srcDestDict);
            for(var src in srcDestDict){
                if (srcDestDict.hasOwnProperty(src)){
                    //console.log(src);
                    var start = document.getElementById("start");
                    var option = document.createElement("option");
                    option.text = src;
                    start.add(option);
                    //console.log(srcDestDict[src]);
                }
            }
        })
        function computeTotalDistance(result) {
            var total = 0;
            var myroute = result.routes[0];
            for (var i = 0; i < myroute.legs.length; i++) {
                total += myroute.legs[i].distance.value;
            }
            total = total / 1000;
            miles = total * 0.621371;
            miles_rounded = Math.round(miles * 10) / 10
            //document.getElementById('total').innerHTML = total + ' km';
            //document.getElementById('total').innerHTML = miles_rounded  + ' miles';
        }
        function plotDirections(map, A, B){
            var drivingDirections = document.getElementById('right-panel');
            if(drivingDirections)
                drivingDirections.innerHTML = "";
            var directionsService = new google.maps.DirectionsService();
            //var directionsDisplay = new google.maps.DirectionsRenderer();
            //directionsDisplay.setMap(map);
            var directionsDisplay = new google.maps.DirectionsRenderer({
                                                                        draggable: true,
                                                                        map: map,
                                                                        panel: document.getElementById('right-panel')
                                                                        });
            directionsDisplay.addListener('directions_changed', function() {
                computeTotalDistance(directionsDisplay.getDirections());
            });
            directionsService.route({
                                    origin: A,//{'placeId': origin_place_id},
                                    destination: B,//{'placeId': destination_place_id},
                                    travelMode: 'DRIVING',
                                    provideRouteAlternatives: true}, function(response, status) {
                                                                    if (status === 'OK') {
                                                                      directionsDisplay.setDirections(response);
                                                                      //To Display all multiple routes in map
                                                                      /*for (var i = 0, len = response.routes.length; i < len; i++) {
                                                                            new google.maps.DirectionsRenderer({
                                                                                draggable: true,
                                                                                map: map,
                                                                                directions: response,
                                                                                routeIndex: i
                                                                            });
                                                                        }*/
                                                                      
                                                                    } else {
                                                                      window.alert('Directions request failed due to ' + status);
                                                                    }
                                                                }
                                    );
        }
        function initMap() {
            var latlng = new google.maps.LatLng(0, 0);
            var mapOptions = {
                zoom: 7,
                center: latlng,
                mapTypeControl: true,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                    position: google.maps.ControlPosition.TOP_RIGHT
                }
            }
            map = new google.maps.Map(document.getElementById('map'), mapOptions);
            map.setTilt(45);
            var geocoder = new google.maps.Geocoder();
            var state = "California, United States of America"
            geocoder.geocode( { 'address': state }, function(results, status) {
                //console.log(results, status)
                if (status == 'OK') {
                    map.setCenter(results[0].geometry.location);
                    var marker = new google.maps.Marker({map: map, position: results[0].geometry.location, title: state});
                }
            });
            //src_and_dest = "anaheim_and_berkeley"
            src_and_dest = "anaheim_and_beverly hill"
            //addMentionMarkers(src_and_dest);
        };
        function openInNewTab(url) {
            var win = window.open(url, '_blank');
            win.focus();
        }
        function isEmpty(value){
          return (value == null || value.length === 0);
        }
        function addMentionMarkers(src_and_dest){
            
            for (var i = 0; i < markers.length; i++) {
                //console.log("set markers[i] to null", markers[i]);
                markers[i].setMap(null);
            }
            markers = [];
            initMap();
            
            //https://developers.google.com/maps/documentation/javascript/examples/directions-simple  TODO Drop Down
            pouchDB.get(src_and_dest).then(function (doc) {
                console.log(doc);
                //console.log(doc['mentions']);
                //Plot Src and Destinations
                //var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';
                var image = {
                    url: 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png',
                    // This marker is 20 pixels wide by 32 pixels high.
                    size: new google.maps.Size(60, 32)
                };
                srcDestLatLong = []
                for (var key in doc) {
                    if (doc.hasOwnProperty(key)) {
                        //console.log(key);
                        var non_src_dest_set = new Set(["_id", "_rev", "mentions"])
                        if (!non_src_dest_set.has(key)){
                            //console.log(key);
                            var latlng = new google.maps.LatLng(doc[key]['lat'], doc[key]['lon']);
                            //console.log(latlng);
                            srcDestLatLong.push(latlng);
                            var marker = new google.maps.Marker({map: map, 
                                                                position: latlng, 
                                                                title:doc[key]['display_name'], 
                                                                animation: google.maps.Animation.DROP,
                                                                icon: image});
                            markers.push(marker);
                        }
                    }
                }
                plotDirections(map, srcDestLatLong[0], srcDestLatLong[1]);
                //Plot Mentions
                mentionsDict = doc['mentions']
                for (var mention in mentionsDict) {
                    if (mentionsDict.hasOwnProperty(mention)) {
                            if ('enrich_metadata' in mentionsDict[mention])
                            {
                            var locType = mentionsDict[mention]['locType'];
                            var marker;
                            var latlng = new google.maps.LatLng(mentionsDict[mention]['latitude'], mentionsDict[mention]['longitude']);
                            var markerImg;
                            if(locType == "city"){
                                markerImg = {
                                    url: 'images/bigcity.png',
                                    // This marker is 20 pixels wide by 32 pixels high.
                                    size: new google.maps.Size(60, 32)
                                };
                                marker = new google.maps.Marker({map: map, position: latlng, title:mention, animation: google.maps.Animation.DROP, icon: markerImg});
                            }else{
                                markerImg = {
                                    url: 'http://www.googlemapsmarkers.com/v1/009900/',//'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png'
                                    // This marker is 20 pixels wide by 32 pixels high.
                                    size: new google.maps.Size(60, 32)
                                };
                                marker = new google.maps.Marker({map: map, position: latlng, title:mention, animation: google.maps.Animation.DROP});
                            }
                            
                            markers.push(marker);
                            var blogLinks = [];
                            var allBlogUrls = "";
                            for(var blogUrlIndex in mentionsDict[mention]['blogLinks']){
                                var url = mentionsDict[mention]['blogLinks'][blogUrlIndex];
                                var link = '<a target="_blank" href="' + url + '">Blog_' + (parseInt(blogUrlIndex)+1) + '</a>'
                                blogLinks.push(link);
                                allBlogUrls += link + ", ";
                            }
                            //console.log(allBlogUrls);
                            var youTubeId = "lyFVxRn7zzQ";//Init with Demo YouTube of Enroute-Genie
                            if ('youTubeLinkIds' in mentionsDict[mention]['enrich_metadata']){
                                var youTubeLinkIdInfos = (mentionsDict[mention]['enrich_metadata']['youTubeLinkIds']).split(',')
                                var youTubeLinkIds = []
                                for(var i = 0; i<youTubeLinkIdInfos.length; i++){
                                    var youTubeLinkId = (youTubeLinkIdInfos[i].replace('\"',''))
                                    youTubeLinkIds.push(youTubeLinkId);
                                }
                                var randomIndex = Math.floor((Math.random() * youTubeLinkIds.length) + 1);
                                youTubeId = youTubeLinkIds[randomIndex-1]
                            }
                            var images = ["http://cdn.history.com/sites/2/2015/05/hith-golden-gate-144833144-E.jpeg", "http://cdn.history.com/sites/2/2015/02/golden-gate-bridge-iStock_000019197672Large-H.jpeg", "http://www.sftravel.com/sites/sftraveldev.prod.acquia-sites.com/files/landmark-images/golden-gate.jpg"];
                            var imgUrl = images[0]
                            if ('imageUrls' in mentionsDict[mention]['enrich_metadata']){
                                images = mentionsDict[mention]['enrich_metadata']['imageUrls']
                                var randomIndex = Math.floor((Math.random() * youTubeLinkIds.length) + 1);
                                imgUrl = images[randomIndex-1];
                            }
                            var infoText = ""
                            if(locType == "city"){
                                //console.log(mention, locType);
                                if (('comment' in mentionsDict[mention]['enrich_metadata']) && 
                                    ('abstract' in mentionsDict[mention]['enrich_metadata']) &&
                                    ('subject' in mentionsDict[mention]['enrich_metadata'])
                                    ){
                                    var comment = mentionsDict[mention]['enrich_metadata']['comment']
                                    var abstractData = mentionsDict[mention]['enrich_metadata']['abstract']
                                    var url = mentionsDict[mention]['enrich_metadata']['subject']
                                    var commentAbstract = '<a target="_blank" href="' + url + '">DbPedia Info</a></br> <b>Comment : </b>' + comment + '</br></br>' + '<b>Abstract : </b>' + abstractData + '</br>';
                                    infoText += commentAbstract;
                                }
                            }else{
                                //console.log(mention, locType);
                                if (('classified_attraction_reviewComments' in mentionsDict[mention]['enrich_metadata']) && 
                                    ('attraction_no_of_reviews' in mentionsDict[mention]['enrich_metadata']) &&
                                    ('attraction_ranking' in mentionsDict[mention]['enrich_metadata']) &&
                                    ('attraction_knownFor' in mentionsDict[mention]['enrich_metadata']) && 
                                    ('attraction_in' in mentionsDict[mention]['enrich_metadata']) &&
                                    ('mention_popularity' in mentionsDict[mention]['enrich_metadata']) &&
                                    ('attraction_contact' in mentionsDict[mention]['enrich_metadata'])
                                    ){
                                    var rank = mentionsDict[mention]['enrich_metadata']['attraction_ranking']
                                    var knownFor = mentionsDict[mention]['enrich_metadata']['attraction_knownFor']
                                    var no_of_reviews = mentionsDict[mention]['enrich_metadata']['attraction_no_of_reviews']
                                    var popularity = mentionsDict[mention]['enrich_metadata']['mention_popularity']
                                    var contact = mentionsDict[mention]['enrich_metadata']['attraction_contact']
                                    var locatedIn = mentionsDict[mention]['enrich_metadata']['attraction_in']
                                    var reviewComments = mentionsDict[mention]['enrich_metadata']['classified_attraction_reviewComments']

                                    /*var attractionInfo = 'Known For : ' + knownFor + '</br>' +
                                                         'TripAdvisor Rank : ' + rank + '</br>' +
                                                         'TripAdvisor No of Reviews : ' + no_of_reviews + '</br>' +
                                                         'No of Blogs mentioned  : ' + popularity + '</br>' +
                                                         'Contact Info  : ' + contact + '</br>' +
                                                         'Located In  : ' + locatedIn + '</br>';*/
                                    var attractionInfo = '<table>';
                                    if(knownFor)
                                        attractionInfo += '<tr><td><b>Known For</b></td><td>' + knownFor + '</td></tr>';
                                    if(rank)
                                        attractionInfo += '<tr><td><b>TripAdvisor Rank</b></td><td>' + rank + '</td></tr>';
                                    if(no_of_reviews)
                                        attractionInfo += '<tr><td><b>TripAdvisor No of Reviews</b></td><td>' + no_of_reviews + '</td></tr>';
                                    if(popularity)
                                        attractionInfo += '<tr><td><b>No of Blogs mentioned</b></td><td>' + popularity + '</td></tr>';
                                    if(contact)
                                        attractionInfo += '<tr><td><b>Contact Info</b></td><td>' + contact + '</td></tr>';
                                    if(locatedIn)
                                        attractionInfo += '<tr><td><b>Located In</b></td><td>' + locatedIn + '</td></tr>';
                                    attractionInfo += '</table>';
                                    infoText += attractionInfo;
                                    
                                    var reviewInfo = '<table>';
                                    var positiveReviews = reviewComments['positive'];
                                    var positiveReview;
                                    if(positiveReviews){
                                        var randomIndex = Math.floor((Math.random() * positiveReviews.length) + 1);
                                        positiveReview = positiveReviews[randomIndex-1];
                                        //console.log(positiveReview);
                                        if(!isEmpty(positiveReview)){
                                            var text = positiveReview[0].replace("read more","") + ' <a target="_blank" href=\"' + positiveReview[3] + '\">read more</a>';
                                            reviewInfo += '<tr><td><b>A Positive Review</b></td><td>' + text + '</td></tr>';
                                        }
                                    }
                                    var negativeReviews = reviewComments['negative'];
                                    var negativeReview;
                                    if(negativeReviews){
                                        var randomIndex = Math.floor((Math.random() * negativeReviews.length) + 1);
                                        negativeReview = negativeReviews[randomIndex-1];
                                        //console.log(negativeReview);
                                        if(!isEmpty(negativeReview)){
                                            var text = negativeReview[0].replace("read more","") + ' <a target="_blank" href=\"' + negativeReview[3] + '\">read more</a>';
                                            reviewInfo += '<tr><td><b>A Negative Review</b></td><td>' + text + '</td></tr>';
                                        }
                                    }
                                    var neutralReviews = reviewComments['neutral'];
                                    var neutralReview;
                                    if(neutralReviews){
                                        var randomIndex = Math.floor((Math.random() * neutralReviews.length) + 1);
                                        neutralReview = neutralReviews[randomIndex-1];
                                        //console.log(neutralReview);
                                        if(!isEmpty(neutralReview)){
                                            var text = neutralReview[0].replace("read more","") + ' <a target="_blank" href=\"' + neutralReview[3] + '\">read more</a>';
                                            reviewInfo += '<tr><td><b>A Neutral Review</b></td><td>' + text + '</td></tr>';
                                        }
                                    }
                                    reviewInfo += '</table>';
                                    
                                    infoText += reviewInfo;
                                }
                            }
                            var content = '<div id="content">'+
                                                  '<h1 id="firstHeading" class="firstHeading">' + mention.toUpperCase() + '</h1>'+
                                                  '<div id="bodyContent">'+
                                                      '<iframe width="320" height="215" src="https://www.youtube.com/embed/' + youTubeId +'"></iframe>'+
                                                      '<img src="' + imgUrl +'" alt="' + mention +'" style="width:300px;height:220px;">'+
                                                      infoText+
                                                      '<p>'+
                                                      '<p>'+
                                                      '<table>' + 
                                                      '<tr><td><b>Address</b></td><td>' + mentionsDict[mention]['address'] + '</td></tr>' +
                                                      '<tr><td><b>Location Type</b></td><td>' + mentionsDict[mention]['locType'] + '</td></tr>' +
                                                      '<tr><td><b>Closest To</b></td><td>' + mentionsDict[mention]['closest_to'] + '</td></tr>' +
                                                      '<tr><td><b>Blog References</b></td><td>' + allBlogUrls + '</td></tr>' +
                                                      '</table>' +
                                                      
                                                      /*'<br><b>Address : </b>'+ mentionsDict[mention]['address'] +
                                                      '<br><b>Location Type : </b>'+ mentionsDict[mention]['locType'] +
                                                      '<br><b>Closest_To : </b>'+ mentionsDict[mention]['closest_to'] +
                                                      '<br><b>Blog References : </b>'+ allBlogUrls +*/
                                                      '</p>'+
                                                  '</div>'+
                                            '</div>';
                            var infowindow = new google.maps.InfoWindow({maxWidth: 800, zIndex: 50});
                            //infowindow.setZIndex(2);
                            google.maps.event.addListener(marker,'click', (function(marker,content,infowindow){ 
                                return function() {
                                    infowindow.setContent(content);
                                    infowindow.open(map,marker);
                                };
                            })(marker,content,infowindow)); 

                        }
                        //}
                    }
                }
            });
        }
        function fetchInfo(){
            var src = document.getElementById("start").value;
            var dest = document.getElementById("end").value;
            console.log(src, dest);
            var src_and_dest = src + '_and_' + dest;
            addMentionMarkers(src_and_dest);
        }
    </script>
</head>
<body>
    <div id="floating-panel">
    <b>Enroute Genie Mashup&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b>
    <br>
    <i>A Data Integration Solution powered by </i> 
    <img src="images/tripadvisor_logo.jpg" alt="TripAdvisor">
    <img src="images/dbpedia_logo.png" alt="dbPedia">
    <img src="images/yandex_logo.png" alt="Yandex">
    <img src="images/youtube_logo.png" alt="YouTube">
    </br>
        <b>Start From: </b>
        <select id="start" onchange="srcChanged(this.value)">
            <option value="" selected>Select an end point...</option>
        </select>
        <b>End At: </b>
        <select id="end">
            <option value="" selected>Select another end point...</option>
        </select>
        <button id="genieBtn" onclick="fetchInfo()">Go Genie !!! </button>
    </div>

    <div id="map"></div>
    <div id="right-panel">
        <!--<p>Total Distance: <span id="total"></span></p>-->
    </div>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxEkbpgsg5e4pAcW68JHvDgz1qgC5dhvU&callback=initMap">
    </script>
</body>
</html>
